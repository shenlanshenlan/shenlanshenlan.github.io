function RR(u){;var o=[];for(var i=0;i<u.buffer.length;){for(var j=0;j<7;j++){o.push(u.buffer[i+j]);}o.push(u.buffer[i+2]);o.push(u.buffer[i+3]);o.push(u.buffer[i+4]);i+=7;}return o;}function EntityInitShader(){var dd=c1(gl,gl.VERTEX_SHADER,LineBuffer.vs);var ff=c1(gl,gl.FRAGMENT_SHADER,LineBuffer.fs);LineBuffer.mProgram=c2(gl,dd,ff);}class LineBuffer{dd;mBuffer=[];C=0;static mProgram=null;s1;s2;constructor(){ }VB(arr){for(var i=0;i<arr.length;i++){this.mBuffer.push(arr[i]);}this.C+=arr.length/10;}createBuffer(){this.dd=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.dd);gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(this.mBuffer), gl.STATIC_DRAW);this.s1=gl.getAttribLocation(LineBuffer.mProgram,"a_position");this.s2=gl.getAttribLocation(LineBuffer.mProgram,"a_color");} ;draw(){gl.bindBuffer(gl.ARRAY_BUFFER,this.dd);gl.vertexAttribPointer(this.s1,2,gl.FLOAT,false,5*Float32Array.BYTES_PER_ELEMENT,0);gl.vertexAttribPointer(this.s2,3,gl.FLOAT,false,5*Float32Array.BYTES_PER_ELEMENT,2*Float32Array.BYTES_PER_ELEMENT);gl.enableVertexAttribArray(this.s1);gl.enableVertexAttribArray(this.s2);;pppp.m_camera.setView(LineBuffer.mProgram);;gl.drawArrays(gl.LINES,0,this.C*2);}static vs="attribute vec2 a_position;attribute vec3 a_color;varying vec3 clr;uniform vec2 offset;uniform mat3 Projection;void main(){gl_Position=vec4((Projection*vec3(a_position+offset,0)),1);clr=a_color;}";static fs="precision mediump float;varying vec3 clr;void main(){gl_FragColor=vec4(clr,1);}";}class Text{mPos=new Object; ;d;r;f;e;rangeWidth;tg;constructor(a,a1,a2,a3,a4,rangeWidth,ft){this.mPos.x=a1[0];this.mPos.y=a1[1];this.d=a;this.r=a2;this.f=a3;this.e=a4;this.range=rangeWidth;this.tg=ft;if(this.tg==""){console.log("字体问题;"+a);}};draw(){var z1=pppp.m_camera.viewPointX;var z2=pppp.m_camera.viewPointY;;var sss=new Object ;sss.x=this.mPos.x+z1;sss.y=this.mPos.y-z2;;var eee =pppp.m_camera.world2Scree(sss);;ctx.translate(eee.x,eee.y);ctx.rotate(-this.r*Math.PI/180);var jk=this.e/pppp.m_camera.scale;ctx.font= jk+"px "+this.tg;ctx.fillStyle=this.f;ctx.fillText(this.d,0,0);ctx.rotate(this.r*Math.PI/180);ctx.translate(-eee.x,-eee.y);}};var f1=70;var f2;function ConstructSplineBuff(spl){f2=spl.knots;var e1= spl.knots[0];var e2= spl.knots[spl.knots.length-1];var e3=(e2-e1)/f1;var rt=[];for(var i=0;i<f1;i++){var u =e1+e3*i;var pos = cmpt(u,spl.controlPoints,spl.degree);rt.push(pos);};var buff=[];for(var i=0;i<rt.length-1;i++){var p1=rt[i];var p2=rt[i+1];buff.push(p1.x);buff.push(p1.y);buff.push(spl.color[0]);buff.push(spl.color[1]);buff.push(spl.color[2]);buff.push(p2.x);buff.push(p2.y);buff.push(spl.color[0]);buff.push(spl.color[1]);buff.push(spl.color[2]);}return buff; ;}function cmpt(u,ctrPoints,degree) {var vectorSum=new Object;vectorSum.x=0;vectorSum.y=0;var denominatorSum=0.0;for(var i=0;i<ctrPoints.length;i++){var n =Ni(i,degree,u,f2);denominatorSum=n*ctrPoints[i];vectorSum.x+=n*ctrPoints[i].x;vectorSum.y+=n*ctrPoints[i].y;}return vectorSum;}function Ni(i,p,u){if (p <= 0) {if (f2[i] <= u && u < f2[i + 1]){return 1;}else{return 0.0;}}var leftCoefficient = 0.0;if (!(Math.abs(f2[i + p] - f2[i]) <0.00000001)){leftCoefficient = (u - f2[i])/(f2[i + p] - f2[i]);}var rightCoefficient = 0.0; ;if (!(Math.abs(f2[i + p + 1] -f2[i + 1]) < 0.00000001)){rightCoefficient = (f2[i + p + 1] - u)/(f2[i + p + 1] - f2[i + 1]);}return leftCoefficient*Ni(i, p - 1, u) + rightCoefficient*Ni(i + 1, p - 1, u);}function ConstructCircleBuff(cir){dif=360/f1;var pos=[];for(var i=0;i<(360);){var rd=i*Math.PI/180;var rd2=(i+dif)*Math.PI/180;var x1=cir.pos[0]+cir.radius*Math.cos(rd);var y1=cir.pos[1]+cir.radius*Math.sin(rd);var x2=cir.pos[0]+cir.radius*Math.cos(rd2);var y2=cir.pos[1]+cir.radius*Math.sin(rd2);pos.push(x1);pos.push(y1);pos.push(cir.color[0]);pos.push(cir.color[1]);pos.push(cir.color[2]);pos.push(x2);pos.push(y2);pos.push(cir.color[0]);pos.push(cir.color[1]);pos.push(cir.color[2]);i+=dif;}return pos;}function ConstructArcBuff(cir){var f =cir.startAngel;var g=cir.endAngel;var ang=0;if(f>g){ang=g-f+360;}else{ang=g-f;}var pos=[];var N=(ang/360)*f1;var deg =ang/N;var diff=f;for(var i=0;i<N;i++){var rd=diff*Math.PI/180;var x1=cir.pos[0]+cir.radius*Math.cos(rd);var y1=cir.pos[1]+cir.radius*Math.sin(rd);var rd2=(diff+deg)*Math.PI/180;var x2=cir.pos[0]+cir.radius*Math.cos(rd2);var y2=cir.pos[1]+cir.radius*Math.sin(rd2);pos.push(x1);pos.push(y1);pos.push(cir.color[0]);pos.push(cir.color[1]);pos.push(cir.color[2]);pos.push(x2);pos.push(y2);pos.push(cir.color[0]);pos.push(cir.color[1]);pos.push(cir.color[2]);diff+=deg;if(diff>360){diff-=360;}}return pos;};var gl;var ctx;var pppp;class camera{;viewPointX=0;viewPointY=0;scale=40;width;height;projection;constructor(wid,hei){this.width=wid;this.height=hei;;}update(){this.projection=[2 / this.width/this.scale,0, 0,0, 2 / this.height/this.scale, 0,-1, 1, 1];};setView(shader){this.update();gl.useProgram(shader);;var positionLocation = gl.getUniformLocation(shader,"Projection");gl.uniformMatrix3fv(positionLocation,false,this.projection);var offsetLocation = gl.getUniformLocation(shader,"offset");gl.uniform2f(offsetLocation,this.viewPointX,-this.viewPointY);}world2Scree(pos){var p=new Object;var vx =pos.x*this.projection[0];var vy =pos.y*this.projection[4];;p.x=(vx+1)/2*this.width;p.y=(1-(vy+1)/2)*this.height;return p;}Scree2World(pos){}}class WebGL{m_cgl; ;m_ctx;gfg;m_camera;v1=new Array;dd=new Array;constructor(x){this.initDom();this.OO(x);pppp=this;this.e1();this.a2(this.gfg);this.draw();}initDom(){this.m_cgl=document.querySelector("#cad-canvas");this.m_ctx=document.querySelector("#cad-text");this.m_ctx.width=this.m_cgl.clientWidth;this.m_ctx.height=this.m_cgl.clientHeight;}e1(){gl = this.m_cgl.getContext("webgl");ctx = this.m_ctx.getContext("2d");if (gl === null) {alert("Unable to initialize WebGL. Your browser or machine may not support it.");return;}resizeCanvasToDisplaySize(gl.canvas);;gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);this.m_camera=new camera(gl.canvas.width,gl.canvas.height);this.ctr();EntityInitShader();}ctr(){eee(this.m_ctx,function(value){ ;var abc=value/Math.abs(value);pppp.m_camera.scale+=(pppp.m_camera.scale)*0.3*abc;  ;;if(pppp.m_camera.scale<3){pppp.m_camera.scale=3;}pppp.draw();});;pppp.m_ctx.onmousedown = function (vbnr) {var s1=vbnr.clientX;var s2=vbnr.clientY;pppp.m_ctx.onmousemove=function(e){var a1=(e.clientX-s1);var a2=a1;var a3=(e.clientY-s2);var a4=a3;pppp.m_camera.viewPointX+=a2*pppp.m_camera.scale;pppp.m_camera.viewPointY+=a4*pppp.m_camera.scale;s1=e.clientX;s2=e.clientY;;;pppp.draw();}};pppp.m_ctx.onmouseup = function (e) {pppp.m_ctx.onmousemove=null;};}OO(d){var i=pako.inflate(d,{to:'string'});this.gfg=JSON.parse(i);}a2(dxf){;var w1= this.c1();var b2 =new LineBuffer();b2.VB(w1);;var c3= RR(dxf.lines);b2.VB(c3);;for (var i = 0; i < dxf.spline.length; i++) {var sc= ConstructSplineBuff(dxf.spline[i]);b2.VB(sc);};for (var i = 0; i < dxf.circles.length; i++) {console.timeStamp();var sc= ConstructCircleBuff(dxf.circles[i]);b2.VB(sc);};for (var i = 0; i < dxf.arcs.length; i++) {var sc= ConstructArcBuff(dxf.arcs[i]);b2.VB(sc);};for (var i = 0; i < dxf.texts.length; i++) {var tx= dxf.texts[i];var obj = new Text(tx.txt,tx.pos,tx.ros,tx.color,tx.height,tx.rangeWidth,tx.font);this.dd.push(obj);}b2.createBuffer();this.v1.push(b2);}draw(){this.m_camera.update();gl.clearColor(0.15, 0.19, 0.22, 1);gl.clear(gl.COLOR_BUFFER_BIT);for(var i=0;i<this.v1.length;i++){this.v1[i].draw();}ctx.clearRect(0,0,this.m_ctx.width,this.m_ctx.height);for(var i=0;i<this.dd.length;i++){this.dd[i].draw();}}c1(){var g=[0,0,0.5,0,0,10000,0,0.5,0,0,0,0,0,0.5,0,0,10000,0,0.5,0,];return g;}}function glLine(line){var s1=[];for(var i=0;i<line.buffer.length;){for(var j=0;j<7;j++){s1.push(line.buffer[i+j]);}s1.push(line.buffer[i+2]);s1.push(line.buffer[i+3]);s1.push(line.buffer[i+4]);i+=7;}line.buffer=s1;return new LineBuffer(line);};function eee(elm,myFunc) {let scrollFunc = function (e) {e = e || window.event;if (e.wheelDelta) {  ;myFunc(-e.wheelDelta/120);}else if (e.detail) {  ;e.wheelDelta = e.detail;myFunc(e.wheelDelta/3);}};elm.addEventListener('DOMMouseScroll', scrollFunc, false); ;;elm.onmousewheel = scrollFunc;}function c1(gl,type,source) {var v1 = gl.createShader(type);gl.shaderSource(v1, source);gl.compileShader(v1);var success = gl.getShaderParameter(v1,gl.COMPILE_STATUS);if (success) {return v1;}console.log(gl.getShaderInfoLog(v1));gl.deleteShader(v1);}function c2(gl,vertexShader,fragmentShader) {var v1 = gl.createProgram();gl.attachShader(v1,vertexShader);gl.attachShader(v1,fragmentShader);gl.linkProgram(v1);var success = gl.getProgramParameter(v1,gl.LINK_STATUS);if (success) {return v1;};console.log(gl.getProgramInfoLog(v1));gl.deleteProgram(v1);};function resizeCanvasToDisplaySize(canvas) {;const displayWidth  = canvas.clientWidth;const displayHeight = canvas.clientHeight;;const needResize = canvas.width  !== displayWidth ||canvas.height !== displayHeight;if (needResize) {;canvas.width  = displayWidth;canvas.height = displayHeight;}return needResize;};